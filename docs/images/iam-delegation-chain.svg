<svg xmlns="http://www.w3.org/2000/svg" width="1100" height="680" viewBox="0 0 1100 680" font-family="'Segoe UI', 'Helvetica Neue', Arial, sans-serif">
  <defs>
    <filter id="shadow" x="-2%" y="-2%" width="104%" height="104%">
      <feDropShadow dx="1" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.2"/>
    </filter>
    <marker id="arrowGreen" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#4ecca3" opacity="0.8"/>
    </marker>
    <marker id="arrowRed" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#e94560" opacity="0.8"/>
    </marker>
    <marker id="arrowOrange" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#f0a500" opacity="0.8"/>
    </marker>
    <marker id="arrowPurple" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#c084fc" opacity="0.8"/>
    </marker>
    <linearGradient id="narrowing" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#4ecca3;stop-opacity:0.3"/>
      <stop offset="100%" style="stop-color:#4ecca3;stop-opacity:0.05"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="1100" height="680" rx="8" fill="#0d1117"/>

  <!-- Title -->
  <text x="550" y="38" text-anchor="middle" fill="#e6e6e6" font-size="22" font-weight="700">Delegation Chain — Identity Propagation and Scope Narrowing</text>
  <text x="550" y="60" text-anchor="middle" fill="#8b949e" font-size="13">Delegation can only narrow scope, never expand it — every hop reduces permissions</text>

  <!-- Permission scope narrowing visual (background trapezoid) -->
  <polygon points="80,85 1020,85 860,280 240,280" fill="url(#narrowing)" stroke="none"/>
  <text x="550" y="105" text-anchor="middle" fill="#4ecca3" font-size="11" font-weight="600" opacity="0.6">PERMISSION SCOPE NARROWS AT EACH HOP</text>

  <!-- Human User -->
  <rect x="80" y="115" width="160" height="85" rx="6" fill="#1a1a2e" stroke="#c084fc" stroke-width="2" filter="url(#shadow)"/>
  <text x="160" y="145" text-anchor="middle" fill="#c084fc" font-size="14" font-weight="700">Human User</text>
  <text x="160" y="165" text-anchor="middle" fill="#e6e6e6" font-size="10">IdP authenticated (MFA)</text>
  <text x="160" y="180" text-anchor="middle" fill="#8b949e" font-size="10">Full role permissions</text>

  <!-- Arrow: Human → Orchestrator -->
  <line x1="240" y1="157" x2="310" y2="157" stroke="#c084fc" stroke-width="2" marker-end="url(#arrowPurple)"/>
  <text x="275" y="148" text-anchor="middle" fill="#c084fc" font-size="9" font-weight="600">delegates</text>

  <!-- Orchestrator Agent -->
  <rect x="320" y="115" width="180" height="85" rx="6" fill="#1a1a2e" stroke="#4ecca3" stroke-width="2" filter="url(#shadow)"/>
  <text x="410" y="140" text-anchor="middle" fill="#4ecca3" font-size="14" font-weight="700">Orchestrator Agent</text>
  <text x="410" y="160" text-anchor="middle" fill="#e6e6e6" font-size="10">User identity propagated (OBO)</text>
  <text x="410" y="175" text-anchor="middle" fill="#f0a500" font-size="10">Scoped: user perms intersected</text>
  <text x="410" y="190" text-anchor="middle" fill="#8b949e" font-size="9">DEL-01 · DEL-05</text>

  <!-- Arrow: Orchestrator → Sub-Agent A -->
  <line x1="500" y1="140" x2="570" y2="130" stroke="#4ecca3" stroke-width="1.5" marker-end="url(#arrowGreen)"/>
  <text x="540" y="125" text-anchor="middle" fill="#4ecca3" font-size="9" font-weight="600">sub-delegates</text>

  <!-- Arrow: Orchestrator → Sub-Agent B -->
  <line x1="500" y1="170" x2="570" y2="190" stroke="#4ecca3" stroke-width="1.5" marker-end="url(#arrowGreen)"/>

  <!-- Sub-Agent A (Research) -->
  <rect x="580" y="95" width="180" height="75" rx="6" fill="#0f3460" stroke="#1a6f9a" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="670" y="120" text-anchor="middle" fill="#e6e6e6" font-size="12" font-weight="600">Research Agent</text>
  <text x="670" y="138" text-anchor="middle" fill="#f0a500" font-size="10">Read-only data access</text>
  <text x="670" y="155" text-anchor="middle" fill="#8b949e" font-size="9">Further narrowed from orchestrator</text>

  <!-- Sub-Agent B (Action) -->
  <rect x="580" y="180" width="180" height="75" rx="6" fill="#0f3460" stroke="#1a6f9a" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="670" y="205" text-anchor="middle" fill="#e6e6e6" font-size="12" font-weight="600">Action Agent</text>
  <text x="670" y="223" text-anchor="middle" fill="#f0a500" font-size="10">Write access (specific tools only)</text>
  <text x="670" y="240" text-anchor="middle" fill="#8b949e" font-size="9">Human approval for irreversible</text>

  <!-- Arrow: Sub-Agent A → Tool -->
  <line x1="760" y1="132" x2="830" y2="132" stroke="#4ecca3" stroke-width="1.5" marker-end="url(#arrowGreen)"/>

  <!-- Arrow: Sub-Agent B → Tool (needs approval) -->
  <line x1="760" y1="217" x2="830" y2="217" stroke="#f0a500" stroke-width="1.5" marker-end="url(#arrowOrange)"/>

  <!-- Tool (read) -->
  <rect x="840" y="110" width="140" height="50" rx="5" fill="#1a3a5c" stroke="#4ecca3" stroke-width="1"/>
  <text x="910" y="133" text-anchor="middle" fill="#4ecca3" font-size="11" font-weight="600">Database (read)</text>
  <text x="910" y="150" text-anchor="middle" fill="#8b949e" font-size="9">Row-level: user's data only</text>

  <!-- Tool (write, needs approval) -->
  <rect x="840" y="195" width="140" height="50" rx="5" fill="#2d2a00" stroke="#f0a500" stroke-width="1"/>
  <text x="910" y="218" text-anchor="middle" fill="#f0a500" font-size="11" font-weight="600">Payment API</text>
  <text x="910" y="235" text-anchor="middle" fill="#8b949e" font-size="9">HITL gate (IAM-05)</text>

  <!-- What flows through the chain -->
  <rect x="60" y="300" width="1000" height="130" rx="6" fill="#1a1a2e" stroke="#533483" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="80" y="325" fill="#c084fc" font-size="14" font-weight="700">WHAT FLOWS THROUGH THE CHAIN</text>

  <rect x="80" y="340" width="220" height="35" rx="4" fill="#2d1b4e" stroke="#533483" stroke-width="1"/>
  <text x="190" y="362" text-anchor="middle" fill="#e6e6e6" font-size="11" font-weight="600">User Identity (immutable)</text>

  <rect x="320" y="340" width="220" height="35" rx="4" fill="#2d1b4e" stroke="#533483" stroke-width="1"/>
  <text x="430" y="362" text-anchor="middle" fill="#e6e6e6" font-size="11" font-weight="600">Delegation Chain ID</text>

  <rect x="560" y="340" width="220" height="35" rx="4" fill="#2d1b4e" stroke="#533483" stroke-width="1"/>
  <text x="670" y="362" text-anchor="middle" fill="#e6e6e6" font-size="11" font-weight="600">Scoped Permissions (narrowed)</text>

  <rect x="800" y="340" width="240" height="35" rx="4" fill="#2d1b4e" stroke="#533483" stroke-width="1"/>
  <text x="920" y="362" text-anchor="middle" fill="#e6e6e6" font-size="11" font-weight="600">Time-Bound Token (short-lived)</text>

  <text x="80" y="405" fill="#8b949e" font-size="11">Every action logged with: originating user + chain of agents that handled it + final tool invoked + result</text>
  <text x="80" y="420" fill="#8b949e" font-size="10">Standards: OAuth 2.0 On-Behalf-Of · Nested JWT (sub + act.sub) · SPIFFE for workload identity · DEL-01 through DEL-05</text>

  <!-- What CANNOT flow -->
  <rect x="60" y="450" width="1000" height="100" rx="6" fill="#3a1a1a" stroke="#e94560" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="80" y="475" fill="#e94560" font-size="14" font-weight="700">WHAT MUST NOT HAPPEN</text>

  <text x="80" y="500" fill="#e6e6e6" font-size="12">Privilege escalation: sub-agent requests permissions the user does not have</text>
  <line x1="700" y1="493" x2="740" y2="493" stroke="#e94560" stroke-width="2" marker-end="url(#arrowRed)"/>
  <text x="755" y="498" fill="#e94560" font-size="11" font-weight="600">BLOCKED at gateway</text>

  <text x="80" y="522" fill="#e6e6e6" font-size="12">Identity loss: action reaches a tool with no traceable originating user</text>
  <line x1="700" y1="515" x2="740" y2="515" stroke="#e94560" stroke-width="2" marker-end="url(#arrowRed)"/>
  <text x="755" y="520" fill="#e94560" font-size="11" font-weight="600">BLOCKED — no identity, no action</text>

  <text x="80" y="540" fill="#e94560" font-size="10" font-weight="600">Governance rule: If the chain breaks, the action fails. Silent privilege expansion is the primary threat in multi-agent systems.</text>

  <!-- Depth limits -->
  <rect x="60" y="570" width="320" height="50" rx="5" fill="#1e1e3f" stroke="#4ecca3" stroke-width="1"/>
  <text x="220" y="592" text-anchor="middle" fill="#4ecca3" font-size="12" font-weight="600">Tier 1: No delegation</text>
  <text x="220" y="608" text-anchor="middle" fill="#8b949e" font-size="10">Single agent, human-supervised</text>

  <rect x="400" y="570" width="320" height="50" rx="5" fill="#1e1e3f" stroke="#f0a500" stroke-width="1"/>
  <text x="560" y="592" text-anchor="middle" fill="#f0a500" font-size="12" font-weight="600">Tier 2: Max 2 hops</text>
  <text x="560" y="608" text-anchor="middle" fill="#8b949e" font-size="10">Orchestrator + one sub-agent</text>

  <rect x="740" y="570" width="320" height="50" rx="5" fill="#1e1e3f" stroke="#e94560" stroke-width="1"/>
  <text x="900" y="592" text-anchor="middle" fill="#e94560" font-size="12" font-weight="600">Tier 3: Max 3 hops</text>
  <text x="900" y="608" text-anchor="middle" fill="#8b949e" font-size="10">Deep chains — full audit trail mandatory</text>

  <!-- Footer -->
  <text x="550" y="660" text-anchor="middle" fill="#484f58" font-size="10">AI Runtime Behaviour Security — IAM Governance · Delegation and Attribution · github.com/JonathanCGill</text>
</svg>
