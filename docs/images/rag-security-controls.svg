<svg xmlns="http://www.w3.org/2000/svg" width="1100" height="680" viewBox="0 0 1100 680" font-family="'Segoe UI', 'Helvetica Neue', Arial, sans-serif">
  <defs>
    <marker id="arr" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#586069"/>
    </marker>
    <marker id="arrDown" markerWidth="6" markerHeight="8" refX="3" refY="8" orient="auto">
      <polygon points="0 0, 6 0, 3 8" fill="#586069"/>
    </marker>
    <filter id="s" x="-2%" y="-2%" width="104%" height="104%">
      <feDropShadow dx="0" dy="1" stdDeviation="2" flood-opacity="0.08"/>
    </filter>
  </defs>

  <rect width="1100" height="680" rx="8" fill="#FAFBFC"/>

  <!-- Title -->
  <text x="550" y="34" text-anchor="middle" font-size="18" font-weight="700" fill="#1B1F23">RAG Pipeline â€” Security Control Points</text>
  <text x="550" y="52" text-anchor="middle" font-size="11" fill="#6A737D">Two flows, six control categories. Green shields mark where controls are applied.</text>

  <!-- ================================================================ -->
  <!-- FLOW 1: INGESTION (top) -->
  <!-- ================================================================ -->

  <!-- Flow label -->
  <rect x="20" y="76" width="110" height="22" rx="4" fill="#0366D6"/>
  <text x="75" y="91" text-anchor="middle" font-size="10" font-weight="700" fill="white">INGESTION FLOW</text>

  <!-- Source Documents -->
  <rect x="30" y="115" width="150" height="60" rx="6" fill="#F6F8FA" stroke="#D1D5DA" stroke-width="1.5" filter="url(#s)"/>
  <text x="105" y="141" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Source</text>
  <text x="105" y="157" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Documents</text>

  <!-- Arrow -->
  <line x1="180" y1="145" x2="230" y2="145" stroke="#586069" stroke-width="1.5" marker-end="url(#arr)"/>

  <!-- CONTROL: Source Auth + Content Validation -->
  <rect x="195" y="100" width="20" height="20" rx="4" fill="#28A745" opacity="0.9"/>
  <text x="205" y="114" text-anchor="middle" font-size="12" fill="white" font-weight="bold">ðŸ›¡</text>

  <!-- Ingestion Pipeline -->
  <rect x="230" y="115" width="150" height="60" rx="6" fill="#DAFBE1" stroke="#34D058" stroke-width="1.5" filter="url(#s)"/>
  <text x="305" y="141" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Ingestion</text>
  <text x="305" y="157" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Pipeline</text>

  <!-- Arrow -->
  <line x1="380" y1="145" x2="430" y2="145" stroke="#586069" stroke-width="1.5" marker-end="url(#arr)"/>

  <!-- CONTROL: Content Sanitisation -->
  <rect x="395" y="100" width="20" height="20" rx="4" fill="#28A745" opacity="0.9"/>
  <text x="405" y="114" text-anchor="middle" font-size="12" fill="white" font-weight="bold">ðŸ›¡</text>

  <!-- Embedding Model -->
  <rect x="430" y="115" width="150" height="60" rx="6" fill="#FFF5B1" stroke="#F9C513" stroke-width="1.5" filter="url(#s)"/>
  <text x="505" y="141" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Embedding</text>
  <text x="505" y="157" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Model</text>

  <!-- Arrow -->
  <line x1="580" y1="145" x2="630" y2="145" stroke="#586069" stroke-width="1.5" marker-end="url(#arr)"/>

  <!-- Vector Store -->
  <rect x="630" y="115" width="150" height="60" rx="6" fill="#F1E5F9" stroke="#8A63D2" stroke-width="1.5" filter="url(#s)"/>
  <text x="705" y="141" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Vector</text>
  <text x="705" y="157" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Store</text>

  <!-- CONTROL: Encryption + Access Control + Audit -->
  <rect x="795" y="100" width="20" height="20" rx="4" fill="#28A745" opacity="0.9"/>
  <text x="805" y="114" text-anchor="middle" font-size="12" fill="white" font-weight="bold">ðŸ›¡</text>

  <!-- Metadata flows alongside -->
  <rect x="230" y="182" width="550" height="22" rx="3" fill="#E1E4E8" stroke="#D1D5DA" stroke-width="1"/>
  <text x="505" y="197" text-anchor="middle" font-size="9" fill="#586069" font-weight="600">METADATA: source | author | classification | access permissions | hash | timestamp</text>

  <!-- Downward connector from Vector Store to query flow -->
  <line x1="705" y1="175" x2="705" y2="290" stroke="#586069" stroke-width="1.5" stroke-dasharray="6,4"/>

  <!-- ================================================================ -->
  <!-- FLOW 2: QUERY (bottom) -->
  <!-- ================================================================ -->

  <!-- Flow label -->
  <rect x="20" y="270" width="90" height="22" rx="4" fill="#E36209"/>
  <text x="65" y="285" text-anchor="middle" font-size="10" font-weight="700" fill="white">QUERY FLOW</text>

  <!-- User Query -->
  <rect x="30" y="310" width="150" height="60" rx="6" fill="#F6F8FA" stroke="#D1D5DA" stroke-width="1.5" filter="url(#s)"/>
  <text x="105" y="336" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">User</text>
  <text x="105" y="352" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Query</text>

  <!-- Arrow -->
  <line x1="180" y1="340" x2="230" y2="340" stroke="#586069" stroke-width="1.5" marker-end="url(#arr)"/>

  <!-- Input Guardrails -->
  <rect x="195" y="295" width="20" height="20" rx="4" fill="#28A745" opacity="0.9"/>
  <text x="205" y="309" text-anchor="middle" font-size="12" fill="white" font-weight="bold">ðŸ›¡</text>

  <!-- Embedding Model (query) -->
  <rect x="230" y="310" width="150" height="60" rx="6" fill="#FFF5B1" stroke="#F9C513" stroke-width="1.5" filter="url(#s)"/>
  <text x="305" y="336" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Embedding</text>
  <text x="305" y="352" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Model</text>

  <!-- Arrow -->
  <line x1="380" y1="340" x2="430" y2="340" stroke="#586069" stroke-width="1.5" marker-end="url(#arr)"/>

  <!-- Similarity Search -->
  <rect x="430" y="310" width="150" height="60" rx="6" fill="#F1E5F9" stroke="#8A63D2" stroke-width="1.5" filter="url(#s)"/>
  <text x="505" y="336" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Similarity</text>
  <text x="505" y="352" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Search</text>

  <!-- Arrow -->
  <line x1="580" y1="340" x2="630" y2="340" stroke="#586069" stroke-width="1.5" marker-end="url(#arr)"/>

  <!-- ========== ACCESS CONTROL GATE (prominent) ========== -->
  <rect x="586" y="296" width="38" height="88" rx="4" fill="#28A745" opacity="0.15" stroke="#28A745" stroke-width="2"/>
  <text x="605" y="345" text-anchor="middle" font-size="9" font-weight="700" fill="#28A745" transform="rotate(-90,605,345)">ACCESS CHECK</text>

  <!-- Retrieved Chunks (post-filter) -->
  <rect x="630" y="310" width="150" height="60" rx="6" fill="#DAFBE1" stroke="#34D058" stroke-width="1.5" filter="url(#s)"/>
  <text x="705" y="336" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Retrieved</text>
  <text x="705" y="352" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Chunks (filtered)</text>

  <!-- Arrow -->
  <line x1="780" y1="340" x2="830" y2="340" stroke="#586069" stroke-width="1.5" marker-end="url(#arr)"/>

  <!-- CONTROL: Delimiter isolation + sanitisation -->
  <rect x="795" y="295" width="20" height="20" rx="4" fill="#28A745" opacity="0.9"/>
  <text x="805" y="309" text-anchor="middle" font-size="12" fill="white" font-weight="bold">ðŸ›¡</text>

  <!-- LLM Prompt -->
  <rect x="830" y="310" width="120" height="60" rx="6" fill="#DBEDFF" stroke="#0366D6" stroke-width="1.5" filter="url(#s)"/>
  <text x="890" y="336" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">LLM</text>
  <text x="890" y="352" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Prompt</text>

  <!-- Arrow -->
  <line x1="950" y1="340" x2="1000" y2="340" stroke="#586069" stroke-width="1.5" marker-end="url(#arr)"/>

  <!-- Response -->
  <rect x="1000" y="310" width="75" height="60" rx="6" fill="#F6F8FA" stroke="#D1D5DA" stroke-width="1.5" filter="url(#s)"/>
  <text x="1037" y="345" text-anchor="middle" font-size="12" font-weight="600" fill="#24292E">Response</text>

  <!-- CONTROL: Output Guardrails + Judge -->
  <rect x="968" y="295" width="20" height="20" rx="4" fill="#28A745" opacity="0.9"/>
  <text x="978" y="309" text-anchor="middle" font-size="12" fill="white" font-weight="bold">ðŸ›¡</text>

  <!-- ================================================================ -->
  <!-- CONTROL ANNOTATIONS (below the flows) -->
  <!-- ================================================================ -->

  <!-- Annotation lines connecting shields to descriptions -->
  <!-- Using a clean grid of control descriptions -->

  <rect x="30" y="420" width="1045" height="245" rx="8" fill="white" stroke="#E1E4E8" stroke-width="1"/>
  <text x="50" y="445" font-size="13" font-weight="700" fill="#24292E">Control Points</text>

  <!-- Row 1 -->
  <rect x="50" y="460" width="16" height="16" rx="3" fill="#28A745"/>
  <text x="60" y="473" text-anchor="middle" font-size="9" fill="white" font-weight="bold">1</text>
  <text x="76" y="473" font-size="11" font-weight="600" fill="#24292E">Source Authentication &amp; Content Validation</text>
  <text x="76" y="488" font-size="10" fill="#586069">Verify document origin. Scan for adversarial patterns before ingestion. Log everything.</text>

  <rect x="560" y="460" width="16" height="16" rx="3" fill="#28A745"/>
  <text x="570" y="473" text-anchor="middle" font-size="9" fill="white" font-weight="bold">2</text>
  <text x="586" y="473" font-size="11" font-weight="600" fill="#24292E">Content Sanitisation</text>
  <text x="586" y="488" font-size="10" fill="#586069">Strip prompt-injection patterns. Preserve metadata. Hash for integrity checks.</text>

  <!-- Row 2 -->
  <rect x="50" y="506" width="16" height="16" rx="3" fill="#28A745"/>
  <text x="60" y="519" text-anchor="middle" font-size="9" fill="white" font-weight="bold">3</text>
  <text x="76" y="519" font-size="11" font-weight="600" fill="#24292E">Vector Store Security</text>
  <text x="76" y="534" font-size="10" fill="#586069">Encryption at rest and in transit. Network segmentation. Audit logging. Embedding integrity.</text>

  <rect x="560" y="506" width="16" height="16" rx="3" fill="#28A745"/>
  <text x="570" y="519" text-anchor="middle" font-size="9" fill="white" font-weight="bold">4</text>
  <text x="586" y="519" font-size="11" font-weight="600" fill="#24292E">Query-Time Access Control</text>
  <text x="586" y="534" font-size="10" fill="#586069">Filter retrieved chunks by user permissions after similarity search, before LLM sees them.</text>

  <!-- Row 3 -->
  <rect x="50" y="552" width="16" height="16" rx="3" fill="#28A745"/>
  <text x="60" y="565" text-anchor="middle" font-size="9" fill="white" font-weight="bold">5</text>
  <text x="76" y="565" font-size="11" font-weight="600" fill="#24292E">Prompt Isolation</text>
  <text x="76" y="580" font-size="10" fill="#586069">Delimiter wrapping. Instruction hierarchy. Retrieved content treated as data, not instructions.</text>

  <rect x="560" y="552" width="16" height="16" rx="3" fill="#28A745"/>
  <text x="570" y="565" text-anchor="middle" font-size="9" fill="white" font-weight="bold">6</text>
  <text x="586" y="565" font-size="11" font-weight="600" fill="#24292E">Output Guardrails &amp; Judge Evaluation</text>
  <text x="586" y="580" font-size="10" fill="#586069">PII detection. Scope consistency checks. "Was response influenced by embedded instructions?"</text>

  <!-- Row 4 â€” honest assessment -->
  <line x1="50" y1="602" x2="1045" y2="602" stroke="#E1E4E8" stroke-width="1"/>
  <rect x="50" y="614" width="12" height="12" rx="2" fill="#D73A49"/>
  <text x="72" y="625" font-size="10" font-weight="600" fill="#D73A49">Honest assessment:</text>
  <text x="188" y="625" font-size="10" fill="#586069">Controls 1â€“3 reduce ingestion risk. Control 4 is the highest-priority single control. Controls 5â€“6 address output risk.</text>
  <text x="72" y="643" font-size="10" fill="#586069">Indirect prompt injection (Control 5) remains an unsolved problem. These controls reduce risk; they don't eliminate it.</text>

  <!-- ================================================================ -->
  <!-- NUMBERED ANNOTATIONS ON THE DIAGRAM -->
  <!-- ================================================================ -->
  <!-- Numbers next to each shield, matching the grid below -->
  <circle cx="205" cy="92" r="8" fill="#28A745"/>
  <text x="205" y="96" text-anchor="middle" font-size="9" fill="white" font-weight="bold">1</text>

  <circle cx="405" cy="92" r="8" fill="#28A745"/>
  <text x="405" y="96" text-anchor="middle" font-size="9" fill="white" font-weight="bold">2</text>

  <circle cx="805" cy="92" r="8" fill="#28A745"/>
  <text x="805" y="96" text-anchor="middle" font-size="9" fill="white" font-weight="bold">3</text>

  <!-- Query flow numbers -->
  <circle cx="205" cy="287" r="8" fill="#28A745"/>
  <text x="205" y="291" text-anchor="middle" font-size="9" fill="white" font-weight="bold">1</text>

  <circle cx="605" cy="287" r="8" fill="#28A745"/>
  <text x="605" y="291" text-anchor="middle" font-size="9" fill="white" font-weight="bold">4</text>

  <circle cx="805" cy="287" r="8" fill="#28A745"/>
  <text x="805" y="291" text-anchor="middle" font-size="9" fill="white" font-weight="bold">5</text>

  <circle cx="978" cy="287" r="8" fill="#28A745"/>
  <text x="978" y="291" text-anchor="middle" font-size="9" fill="white" font-weight="bold">6</text>

</svg>
